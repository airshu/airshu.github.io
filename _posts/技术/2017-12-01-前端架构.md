---
layout: post
title: 前端架构
category: 技术
tags: 前端
keywords: 
description: 
---


# PC_Gulp+Seajs

## 1、目录

* SVN
	- templates/aipai_platform/pc/build/gulpfile.js
	
* GIT 
	- AipaiPlatformTemplates/templates/aipai_platform/pc/build/gulpfile.js



## 2、命令
* 备注：在build目录下执行命令，xxx表示目录文件名

* 压缩common组件
`gulp apm`
* 压缩业务脚本
`gulp combojs --m xxx`
* 生成js模版
`gulp tmod --m xxx`
* 实时刷新html、less编译
`gulp f5 --m xxx`

## 3、开发
```javascript
	seajs.use((seajs.dev ? (seajs.deploy ? "/app/www/templates/aipai_platform/pc/index/" : "./") : "pc/index/") + "js/index_v2");
	
	//  http://www.aipai.com/?dev=true
	//  开发模式，引入的业务脚本是开发模式（不混淆合并），但是各个组件都是压缩合并的
	//即：http://www.aipai.com/app/www/templates/aipai_platform/pc/index/js/index_v2.js?t=1501208854392
```

## 4、压缩上线
在build目录下执行命令：gulp combojs --m index

```javascript
	seajs.use((seajs.dev ? (seajs.deploy ? "/app/www/templates/aipai_platform/pc/index/" : "./") : "pc/index/") + "js/index_v2");
	
	//  http://www.aipai.com/
	//  开发模式，引入的业务脚本是开发模式（不混淆合并），但是各个组件都是压缩合并的
	//即：http://www.aipai.com/aipai_platform/pc/common/dist/pc/index/js/index_v2.js?v=0.02474745872405215
```

## 5、常见问题
* 当前页面域名跟引入js文件的域名一致本地存储成生效
* 当前页面域名跟引入js文件的域名不一致，需要定全局变量 = 静态资源域名

```javascript
	var WinResourcesDomain = 'http://res28.weplay.cn/';
```
* seajs的基本路径（base）：dist目录下

```javascript
	'http://res28.weplay.cn/aipai_platform/pc/common/dist/'
	//其中res28.weplay.cn/aipai_platform中的“/”不能有双个，
	
	//比如错误写法：会导致路径出错
	//res28.weplay.cn//aipai_platform
```
* 主js文件压缩合并所有模块，但是在实际的加载中又重新加载各个模块js代码问题：<br />
	原因：在合并过程中没有生成每个模块对应的id or 加载中找不到对应的id的js文件<br />
	解决：检查压缩的主js文件，每个模块是否带id。id的路径是否正确
	
```javascript
	//压缩代码，这个pop需要依赖两个js文件“zepto/zepto/1.0.0/zepto”（id），“./css/pop.css”（路径id）
	define("apm/pop",["zepto/zepto/1.0.0/zepto","./css/pop.css"],function(a,b,c){
		var d=a("zepto/zepto/1.0.0/zepto");
		a("./css/pop.css");
		//代码...
	});
	
	//
	define("apm/css/pop.css",[],function(){
		//代码...
	});
```
> 备注："apm/css/pop.css"(id)在实际加载url地址是：
	seajs的base路径拼接，即：
	http://res28.weplay.cn/aipai_platform/pc/common/dist/apm/css/pop.css.js
	

## 6、构建工具工作
* 语法检查
* cmd模块化
* tmodjs脚本模板
* 混淆、合并js
* 实时刷新
* css Sprite
*  编译sass、less等等
*  压缩包
*  文件MD5版本号管理
*  本地存储

# H5_Grunt+Seajs

## 1、目录

* SVN
	- templates/mobile/build/Gruntfile.js
	- templates/aipai_platform/mobile/build/Gruntfile.js
	- templates/pay_center/mobile/build/Gruntfile.js
	
* GIT 
	- AipaiPlatformTemplates/templates/aipai_platform/mobile/build/Gruntfile.js 



## 2、使用
* 备注：在build目录下执行命令，xxx表示目录文件名

* 压缩common组件
`grunt apm`
* 压缩业务脚本
`grunt combojs:xxx`
* 生成js模版
`grunt tmod:xxx`
* H5专区打压缩包
`grunt toModule:zone_v3`


## 移动前端目录结构
![0](/public/img/qd_w1.png)

## “还原”设计图
##### [腾讯分析移动设备屏幕分辨率分析报告](http://djt.qq.com/article/view/399)
1、常见手机分辨率：

``` bash
* 480*320 (山寨机、三星s5830i、华为C8650+、iPhone3等老一代手机)
* 800*480 (华为C8812，中兴UV880，三星i9100等)
* 960*640 (iPhone4和4s等)
* 1136*640 (iPhone5/5s)
* 1280*720 (三星i9300、n7100、索尼lt26i、魅族M040、小米二代等)
* 1334*750 （iPhone6）
* 1080*1920 (iPhone6 Plus)
```
2、设计图的尺寸历史：

``` bash
* 480*320
* 800*480
* 960*640
* 1136*640
* 1280*720
* 1334*750
```
3、前端适配不同分辨率方法：

a、计算公式：

``` bash
width = 设计元素宽度/(设计图宽度/320)px;
height = 设计元素高度/(设计图宽度/320)px;
```

------
| 设计图的尺寸 | 理论上的比例  | 实际经验的比例 |
|-------|------|-----|
| 480x320<br /> 800X480<br /> 960X640<br /> 1136X640<br /> 1280X720<br /> 1334X750| 1<br /> 1.5<br /> 2<br /> 2<br /> 2.25<br /> 2.34375 | 1<br /> 1.5<br /> 2<br /> 2<br /> 2.2<br /> 2<br /> |

------
b、百分比 && 伸缩布局盒模型（flex）<br />
c、媒体查询（@media）<br />
d、em--相对长度单位？？？

## 开发组件
### 例子 pop.js
1.在目录templates\mobile\common\src\apm 下新建pop.js文件<br />
![0](/public/img/qd_w2.png)

2.配置模块化路径：修改 templates\mobile\common\src\apm\sea.js 文件，添加pop.js路径

![0](/public/img/qd_w3.png)

3.添加pop.js的Grunt操作路径 ：修改 D:\work\templates\mobile\build\Gruntfile.js 文件<br />
![0](/public/img/qd_w4.png)

4.执行grunt命令压缩生成组件：
 进入 终端进入templates\mobile\build目录下执行命令<br />
 grunt apm <br/>
 生成压缩后的组件<br />
![0](/public/img/qd_w5.png)
 
## js开发流程以及组件使用
1. 引入js：开发模式（?dev）,压缩模式<br />
![0](/public/img/qd_w6.png)
2. 按需引入库、组件、js模版<br />
![0](/public/img/qd_w7.png)
3. 调用相应的入库、组件、js模版

## 爱拍移动 - Native APP加userAgent规则
###### 详细参考GitLab[爱拍移动-Native APP加userAgent规则.md](http://gitlab.aipai.com:9090/front/front-end/blob/master/Doc/移动/爱拍移动-Native%20APP加userAgent规则.md)
### 1.规则
```
公司/系统/产品线/app名/v(版本号)

公司：aipai
系统：Android | iOS
产品线：aipai | paidashi | recnow | xifen
app名：
	aipai
	paidashi
	recnow是各自游戏的packageName
	xifen：aipai_cf | aipai_dnf
版本号：v(xxx)
	xxx为最后一位递增的数
	recnow比较特别，为v(123_11)，第一位是游戏的版本，第二位是recnow的版本
```
### 2.判断app信息
```javascript
//全部属性
var opt = {
	o : 'Android' || 'iOS',		//系统
	s : 'aipai',				//产品线
	p : 'aipai',				//app名
	v : 560						//版本号>=560
};
//比如：
apm.app.is({o : 'Android', p: 'aipai', v : 561});
apm.app.is({o : 'iOS', p: 'aipai', v : 285});
```

## 调用原生APP 协议
###### 详细参考GitLab[爱拍移动-WEB调用Native常用接口.md](https://nodejs.org/en/)
1、外部浏览器启动app 首页、播放页、空间页

 ```javascript
$(function(){
	//启动app
	apm.appStart({'action' : 'startApp'});
	//启动某个播放页
	apm.appStart({'action' : 'videoPlayer', 'videoId' : asset_id});
	//启动某个空间页
	apm.appStart({'action' : 'personalSpace', 'bid' : bid });
});
```
2、app内启动原生播放页、空间页

 ```javascript
//启动播放页
if(apm.app.is({o : 'Android', v : 550}) || apm.app.is({o : 'iOS', v : 281})){
    $doc.find('#main_archive #wall_list').on('click', ' .a_video', function(){
        var _vid = $(this).data('vid');
        apm.appBridge('video', _vid);
        return false;
    });
}
//启动空间页
if(apm.app.is({o : 'Android', p: 'aipai', v : 561}) || apm.app.is({o : 'iOS', p: 'aipai', v : 285})){
    $('#main_im .im_list').on('click', 'dl.ty_video .a_home', function () {
        var $ty_videoTs = $(this).parents('dl.ty_video'),
            bid = $ty_videoTs.data('bid'),
            nick = $ty_videoTs.data('uname');
        apm.appBridge('home', encodeURIComponent(JSON.stringify({bid : bid, nick : nick})));
        return false;
    });
}
```
3、微信分享

 ```javascript
define(function(require, exports, module) {
    var apm = require('apm'),
		wxShareData = {
	        title: wxShareTitle,
	        desc: wxShareDesc,
	        imgUrl: wxShareImgUrl,
	        link : marketShareUrl
	    };
    apm.wxShare(wxShareData);
});
```
4、app头部右上角分享

 ```javascript
if((apm.app.is({p:'aipai', o:'iOS',v:299}) || apm.app.is({p:'aipai', o:'Android',v:808}))){
    var setInitShare = {
            title : wxShareTitle,
            content : wxShareDesc,
            imageUrl : wxShareImgUrl,
            targetUrl : wxShareUrl
        };
    apm.appBridge('setInitShare', encodeURIComponent(JSON.stringify(setInitShare)));
}
```
5、调用原生分享弹框组件

 ```javascript
if(apm.app.is({p:'paidashi'}) || apm.app.is({p:'aipai'})){
    var aipaiShare = function(){
        var url = location.href,
            _share_data = {
                title : wxShareTitle,
                content : wxShareDesc,
                targetUrl : marketShareUrl,
                imageUrl : wxShareImgUrl//分享图片的路径
            };
        apm.appBridge('sharepage', encodeURIComponent(JSON.stringify(_share_data)));
    }，
	paidashiShare = function(){
        var _share_data = {
            id : asset_id,
            type : 'share',
            url : marketShareUrl,
            ti : document.title.replace(/Share\+/,""),
            nick : '',
            desc : wxShareDesc,
            work : wxShareImgUrl
        };
        apm.appBridge('sharepage', encodeURIComponent(JSON.stringify(_share_data)));
    };
    $fbar.on('click', '#fbar_down .btn_share', function() {
        if(apm.app.is({p:'paidashi'})){
            paidashiShare();
        }else{
            aipaiShare();
        }
    });
}
```
6、调用原生启动第三方(QQ好友、QQ空间、新浪微博)分享[图文](http://m.aipai.com/mobile/amusement_action-article_id-194.html)

 ```javascript
if(apm.app.is({o : 'Android', p: 'aipai', v : 818}) || apm.app.is({o : 'iOS', p: 'aipai', v : 305})){
    var _xinShare_data = {
            title : wxShareTitle,
            content : wxShareDesc,
            targetUrl : wxShareUrl,
            imageUrl : wxShareImgUrl//分享图片的路径
        };
    $mod_share.find('li.qq a').on('click', function(){
        apm.appBridge('sharepage_qq', encodeURIComponent(JSON.stringify(_xinShare_data)));
        return false;
    });
    $mod_share.find('li.qz a').on('click', function(){
        apm.appBridge('sharepage_qzone', encodeURIComponent(JSON.stringify(_xinShare_data)));
        return false;
    });
    $mod_share.find('li.sina a').on('click', function(){
        apm.appBridge('sharepage_sina', encodeURIComponent(JSON.stringify(_xinShare_data)));
        return false;
    });
}
```
7、加入群功能

 ```javascript
//提供app全局方法
appWinFun.joinGroup = function(opt, param){
    if(parseInt(opt.b, 10) > 0){
		//加入群功能(需要加定时器解决一些安卓无法接收二次调用协议)
        setTimeout(function(){ apm.appBridge('joinGroup', encodeURIComponent(JSON.stringify(param)));}, 200);
    }else{
        if(apm.app.is({p:'aipai', o:'iOS'})){//触发IOS下的登录协议
            apm.appBridge('login','');
        }else{
            var _url = encodeURI(location.href);
            location.href = 'http://m.aipai.com/mobile/login.php?ref='+_url;
        }
    }
    return false;
};
var join_data = {
    gid : $ts.data('gid'),
    gName : $ts.data('gidname'),
    createBid : $ts.data('createbid'),
    type : $ts.data('type')
};
apm.appBridge('function', encodeURIComponent(JSON.stringify({
    action : 'getCookies',
    callback : 'appWinFun.joinGroup',
    cookieNames : ['b'],
    cookieDomain : '.aipai.com',
    param : join_data
})));
```

8、手机绑定功能

 ```javascript
if(apm.app.is({o : 'Android', p : 'aipai', v : 806}) || apm.app.is({o : 'iOS', p: 'aipai', v : 299})){
    //立即绑定
    $('#pop_tips').find('.btns .btn_mobile').on('click', function(){
        apm.appBridge('bindTelephone', '1');
    });
	return false;
}else{
	var bid = cookies.get('b') || 0,
        local_href = location.href;
    $('#pop_tips').find('.btns .btn_mobile').on('click', function(){
        location.href = "http://m.aipai.com/mobile/login_action-verifyPhone_bid-"+bid+"_time-"+ret.verifyPhone.time+"_sign-"+ret.verifyPhone.sign+".html?ref=http://m.aipai.com/mobile/zt/chunjie2016_action-draw.html";
        return false;
    });
}
```
9、ios app审核开关

```javascript
//返回true app正在审核中，false app已审核通过
apm.iOSinReview();
```
10、webview优化（android 808, ios 299）

 ```javascript
//1、设置初始化分享：
var setInitShare = {
    title : window.title,
    content : 'share',
    imageUrl : url,
    targetUrl : tit
};
apm.appBridge('setInitShare', encodeURIComponent(JSON.stringify(setInitShare)));
//2、设置app头部标题文案
var title = '爱拍';
apm.appBridge('setTitle', encodeURIComponent(title));
//3、设置app头部标题图片（高度60px，宽度auto）
var titlePic = 'http://hc30.aipai.com/user/521/27378521/5474970/card/27879790/27879790_400.jpg';
apm.appBridge('setTitlePic', encodeURIComponent(titlePic));
//4、网络出错
var networkError = {
    title : '网络出错',
    content : '网络不给力，请重新加载！',
    btnTxt : '重新加载'
};
apm.appBridge('networkError', encodeURIComponent(JSON.stringify(networkError)));
//5、是否全屏（开始全屏、结束全屏）
apm.appBridge('startFullScreen');//开始全屏
apm.appBridge('endFullScreen');//结束全屏
//6、风云榜指定榜单（全站红人榜、潜力红人榜、新人榜、穿越火线）
apm.appBridge('startAppointRank', encodeURIComponent('全站红人榜'));
//7、其他
apm.appBridge('goToRecord'）;//跳转到拍大师页面
apm.appBridge('addFriend'）;//加好友
apm.appBridge('privateChat'）;//单聊
apm.appBridge('groupChat'）;//群聊
```


# vue构架

## 构架环境
``` bash
vue v2
node >= v6.4.0
npm >=  3.10.3
```

## 构建程序
>备注：执行命令环境：在build目录下。

``` bash
# 开发指令说明
npm install   安装依赖

## 开发模式 目录为同级目录下的文件夹  例：testfile/vue_dome、testfile   可以多层级
npm run dev  -- 目录      例如：npm run dev  -- testfile/vue_dome

## 生产模式 目录结构同开发模式   
## 会把文件编译到build_vue同级目录下的dest_v文件夹下的对应文件夹   只更新dest对应的文件夹到外网即可，开发文件可不用提交外网

npm run build  -- 目录    例如：npm run build  -- testfile/vue_dome

```

>vue公共组件、插件说明

## 使用功能依赖vue组件
* fetch-jsonp  请求jsonp
	- https://www.npmjs.com/package/fetch-jsonp
``` bash
#引入
import fetchJsonp from 'fetch-jsonp';
#使用
fetch(url, param){
    let _param= '';
    for(let key in param){
        _param += key+'='+param[key]+'&';
    }
    return fetchJsonp(url+'?'+_param,{
            timeout: 3000
        })
        .then(function(response) {
            return response.json()
        }).then(function(json) {
            return json;
        }).catch(function(ex) {
            return {error: true, url: ex};
        })
}
```
* vue-cookie
	- https://www.npmjs.com/package/vue-cookie

``` bash
#引入
import Vue from 'vue';
import VueCookie from 'vue-cookie';
Vue.use(VueCookie);
#使用
this.$cookie.get("b")

```
* vue-lazyload
	- https://www.npmjs.com/package/vue-lazyload
	- http://www.8dou5che.com/2017/05/11/vue-lazyload/

``` bash
#引入
import Vue from 'vue'
import VueLazyload from 'vue-lazyload'
Vue.use(VueLazyload)
#使用
<img class="pic" v-lazy="item.productGallery[0].imageUrl" :alt="item.productInfo.title" width="" height="" />

```
## 使用功能开发vue组件
* comment 评论组件

``` bash
# 参数说明 

```

## loaders
* 雪碧图SVG: svg-sprite-loader、svgo-loader
	- https://fe.ele.me/svg-sprite-jian-jie/
	- https://github.com/Rlilyyy/svg-sprites-demo
