
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>ams_config_admin_guide  </title>
   <meta name="author" content="lsj" />

   <link rel="start" href="/" />

	
	
	
  	<link rel="alternate" type="application/atom+xml" href="http://feeds.feedburner.com/feedname" title="RSS feed" />
	
	

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/assets/themes/mark-reid/css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/assets/themes/mark-reid/css/screen.css" type="text/css" />


	
</head>

<body id="">

<div id="header" >
    <h1>
    	<a href="/" title="alonepig's blog" >alonepig's blog</a>
		<!--     	<span class="byline">&larr; <a href="/">lsj</a></span> -->
    </h1>
    <ul class="nav">
      <li><a class="home" href="/">Home</a></li>
      <li><a  href="/archive.html">Archive</a></li>
      <li><a  href="/pages.html">Pages</a></li>
      <li><a  href="/categories.html">Categories</a></li>
      <li><a  href="/tags.html">Tags</a></li>
      <li><a  href="/about.html">About</a></li>
    </ul>
  </div>
</div>

<div id="left">

     <strong>Tag Clound</strong>
     <br />
     <div class="navbar1" >
     	
    		<a href="tags.html#fms-ref" id="1" class="__tag" style="margin: 5px">fms</a>
  		
    		<a href="tags.html#air-ref" id="2" class="__tag" style="margin: 5px">air</a>
  		
    		<a href="tags.html#ios-ref" id="3" class="__tag" style="margin: 5px">ios</a>
  		
    		<a href="tags.html#actionscript-ref" id="4" class="__tag" style="margin: 5px">actionscript</a>
  		
    		<a href="tags.html#error-ref" id="5" class="__tag" style="margin: 5px">error</a>
  		
    		<a href="tags.html#swf-ref" id="6" class="__tag" style="margin: 5px">swf</a>
  		
    		<a href="tags.html#crack-ref" id="7" class="__tag" style="margin: 5px">crack</a>
  		
    		<a href="tags.html#vim-ref" id="8" class="__tag" style="margin: 5px">vim</a>
  		
    		<a href="tags.html#essential actionscript3.0-ref" id="9" class="__tag" style="margin: 5px">essential actionscript3.0</a>
  		
    		<a href="tags.html#p2p-ref" id="10" class="__tag" style="margin: 5px">p2p</a>
  		
    		<a href="tags.html#stock-ref" id="11" class="__tag" style="margin: 5px">stock</a>
  		
    		<a href="tags.html#android-ref" id="12" class="__tag" style="margin: 5px">android</a>
  		
    		<a href="tags.html#java-ref" id="13" class="__tag" style="margin: 5px">java</a>
  		
     </div>
     
     
     <strong>Calendar</strong>
      
     <div class="navbar1" >
     <table cellpadding="0" cellspacing="0" id="1" > 
		<tr> 
		<td><style> 
body,td,.p1,.p2,.i{font-family:arial} 
body{margin:0 0 0 0;background-color:#fff;color:#000;} 
table{border:0} 
#cal{width:100%;border:1px solid #c3d9ff;font-size:12px;margin:0px 0 0 0px} 
#cal #top{height:29px;line-height:29px;background:#e7eef8;color:#003784;padding-left:0px} 
#cal #top select{font-size:12px} 
#cal #top input{padding-right: 0px; right: 0px} 
#cal ul#wk{margin:0;padding:0;height:25px} 
#cal ul#wk li{float:left;width:34.5px;text-align:center;line-height:25px;list-style:none} 
#cal ul#wk li b{font-weight:normal;color:#c60b02} 
#cal #cm{clear:left;border-top:1px solid #ddd;border-bottom:1px dotted #ddd;position:relative} 
#cal #cm .cell{position:absolute;width:42px;height:36px;text-align:center;margin:0 0 0 0px} 
#cal #cm .cell .so{font:bold 16px arial;} 
#cal #bm{text-align:right;height:24px;line-height:24px;padding:0 13px 0 0} 
#cal #bm a{color:7977ce} 
#cal #fd{display:none;position:absolute;border:1px solid #dddddf;background:#feffcd;padding:10px;line-height:21px;width:150px} 
#cal #fd b{font-weight:normal;color:#c60a00} 
</style> 
<!--[if IE]> 
<style> 
#cal #top{padding-top:4px} 
#cal #top input{width:65px} 
#cal #fd{width:170px} 
</style> 
<![endif]--> 
		<div id="cal">
			<div id="top">
				<select>
				</select> 年 <select>
				</select> 月 <span></span> [ <span></span>年 ] <input type="button"
					value="今天" title="点击后跳转回今天" style="padding: 0px">
			</div>
			<ul id="wk">
				<li>一</li>
				<li>二</li>
				<li>三</li>
				<li>四</li>
				<li>五</li>
				<li><b>六</b></li>
				<li><b>日</b></li>
			</ul>
			<div id="cm"></div>
			<div id="bm"></div>
		</div>
		</td>
		</tr>
		</table>
     </div>
     
     
<!-- 	<strong>Blogroll</strong><br /> -->
<!-- 	<div class="navbar1" > -->
<!--      	<ul > -->
<!--      		<li><a href="" target="_blank" ><span >github.com</span></a></li> -->
<!--      	</ul> -->
<!-- 	</div> -->
	
	<!--
	<strong>Find Me</strong><br />
	<div class="navbar1" >
	<ul >
          <li><a href="https://github.com/alonepig" target="_blank" title="Github"><span class="fa fa-github fa-lg">Github</span></a></li>
          <li><a href="http://www.douban.com/people/alonepig" target="_blank" title="douban"><span>豆瓣</span></a></li>
          <li><a href="http://www.zhihu.com/people/alonepig" target="_blank" ><span>知乎</span></a></li>
     </ul>
     </div>
     
     -->
</div>


<div id="site">
  
  
<div id="page">
	
  <h1 class="emphnext">ams_config_admin_guide</h1>
  <ul class="tag_box inline">
  
  


  
     
    	<li><a href="/tags.html#fms-ref">fms <span>14</span></a></li>
    
  



  </ul>

  <h4>Adobe Media Server Configuration and Administration Guide</h4>

<h5>第一章、部署服务器</h5>

<h6>配置端口</h6>

<p>Adobe Media Server默认端口为1935和80.Adobe Media 管理员服务器端口为1111。</p>

<p><strong>端口要求</strong>
<table>
    <tr>
        <td>端口号</td>
        <td>协议</td>
        <td>传输</td>
        <td>描述</td>
    </tr>
    <tr>
        <td>1935</td>
        <td>TRMP/E</td>
        <td>TCP</td>
        <td>默认</td>
    </tr>
    <tr>
        <td>1935</td>
        <td>RTMFP</td>
        <td>UDP</td>
        <td>默认</td>
    </tr>
    <tr>
        <td>80</td>
        <td>RTMP/E,RTMTP,HTTP</td>
        <td>TCP</td>
        <td></td>
    </tr>
    <tr>
        <td>19350-65535</td>
        <td>RTMFP</td>
        <td>UDP</td>
        <td>
        默认情况，客户端使用RTMFP协议，在1935和19350-65535端口上连接AMS。</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">    &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
    &lt;td&gt;8134&lt;/td&gt;
    &lt;td&gt;HTTP&lt;/td&gt;
    &lt;td&gt;TCP&lt;/td&gt;
    &lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
    &lt;td&gt;1111&lt;/td&gt;
    &lt;td&gt;RTMP,HTTP&lt;/td&gt;
    &lt;td&gt;TCP&lt;/td&gt;
    &lt;td&gt;默认情况下，Flash Player，HTML客户端连接AMS管理员服务器的端口。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
    &lt;td&gt;443&lt;/td&gt;
    &lt;td&gt;RTMPS&lt;/td&gt;
    &lt;td&gt;TCP&lt;/td&gt;
    &lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
</code></pre></div>
<p></table></p>

<p><strong>配置IP地址和端口</strong></p>

<p>1、打开rootinstall/conf/ams.ini。</p>

<p>2、编辑ADAPTOR.HOSTPORT参数，默认值为：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">ADAPTOR.HOSTPORT = :1935, 80
</code></pre></div>
<p>3、保存文件重启服务器。</p>

<p>Adaptor.xml配置文件中Adaptor/HostPortList/HostPort标签中使用ADAPTOR.HOSTPORT参数：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;HostPort name=&quot;edge1&quot; ctl_channel=&quot;localhost:19350&quot;
rtmfp=&quot;${ADAPTOR.HOSTPORT}&quot;&gt;${ADAPTOR.HOSTPORT}&lt;/HostPort&gt;
</code></pre></div>
<h6>为RTMFP配置IP地址和端口</h6>

<p><strong>RTMFP连接流</strong></p>

<p>1、RTMFP客户端在1935端口上连接AMS服务器进行UDP传输。</p>

<p>重要：RTMFP和RTMP/E 客户端使用同样的端口连接AMS。但，RTMFP使用UDP，RTMP/E使用TCP。</p>

<p>2、The amsedge process redirects the connection to an amscore process listening on a UDP port in the range 19350-65535</p>

<p>每一个amscore进程有自己的RTMFP监听器。每一个RTMFP监听器绑定一个UDP端口。当amscore进程开始时，监听器绑定一下可用的UDP端口(Adaptor.xml中Adaptor/RTMFP/Core?hostPortList/HostPort标签指定)。
使用的端口的数量取决于amscore进程使用的数量。amscore进程使用的数量取决于应用程序实例是如何分布的。</p>

<p><strong>配置RTMFP重定向端口</strong></p>

<p>1、打开rootinstall/conf/<em>defaultRoot</em>/Adaptor.xml文件</p>

<p>2、编辑HostPort标签，默认情况为：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;Adaptor&gt;
    ...
    &lt;RTMFP&gt;
    ...
        &lt;Core&gt;
            &lt;HostPortList&gt;
                &lt;HostPort&gt;:19350-65535&lt;/HostPort&gt;
            &lt;/HostPortList&gt;
        &lt;/Core&gt;
    &lt;/RTMFP&gt;
&lt;/Adaptor&gt;
</code></pre></div>
<p>3、If the RTMFP adaptor is behind a NAT, specify the in-front-of-NAT IP address that clients connect to in the public attribute of the HostPort element. The following example uses 12.34.56.78 for the in-front-of-NAT IP address:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;HostPort public=&quot;12.34.56.78:19350-65535&quot;&gt;:19350-65535&lt;/HostPort&gt;
</code></pre></div>
<p>4、保存文件。</p>

<p><strong>关于HostPort</strong></p>

<p>HostPort标签的值为以下格式：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;value-of-HostPort&gt; := [&lt;host-port-range&gt; [; &lt;host-port-range&gt; [; ... ] ] ]
&lt;host-port-range&gt; := [&lt;host&gt;][:&lt;port-range&gt;[, &lt;port-range&gt; ] ]
&lt;port-range&gt; := &lt;start-port&gt;[ - &lt;end-port&gt; ]
</code></pre></div>
<p>下面的例子中，每一个监听器有两个端口集合：一个端口来自host1:2000-2010或host2:3000-3010，一个来自host2:5000或host2:2010-4000。</p>

<p><strong>配置服务器在NAT后的公共的IP地址</strong></p>

<p>如果RTMFP适配器在NAT之后，指定客户端连接的HostPort标签public属性来设置in-front-of-NAT IP地址。</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;HostPort public=&quot;&lt;in-front-of-NAT-server-IP&gt;:19350-65535&quot;&gt;:19350-65535&lt;/HostPort&gt;
</code></pre></div>
<p>如果你不指定public属性，服务器不会知道in-front-of-NAT 地址。amdedge进程会重定向客户端到正确的端口，但它会告诉客户端behind-NAT地址，这个地址客户端不能接触。</p>

<p>Each HostPort element can specify a public address that corresponds to the specified port. This is the address that is advertised to clients for the given HostPort. To advertise an address, specify a value for the public attribute of the HostPort element. The public attribute has the same format as the HostPort element. The number of ports specified by the public attribute must equal the number of ports specified by the HostPort element. If the core listens on the n-th port of the HostPort value, the n-th port of the public attribute is advertised as its value.</p>

<p>例子中HostPortList使用public属性，如果核心监听器在host1:1005，它的公共广告地址在host2:4005。</p>

<p><strong>NAT和防火墙穿越</strong></p>

<p>NAT(网络地址转换)和防火墙过滤可以阻止点对点的连接。在内部网应用程序中,您为了对整个网络进行控制,执行以下操作以确保客户可以创建点对点连接:</p>

<ul>
<li>允许在任何防火墙进行UDP通讯</li>
<li>使用IFTF BEHAVE工作组推荐的NAT或防火墙</li>
<li>Use the TURN proxy support in Flash Player to send traffic to a proxy in a DMZ that can comply with the previous recommendations. 
See <a href="http://www.adobe.com/devnet/adobe-media-server/articles/real-time-collaboration.html">Best practices for real-time collaboration using Adobe Media Server.</a></li>
</ul>

<p>In an Internet application, the application developer must choose how to handle cases in which a firewall or NAT blocks a direct peer-to-peer connection. To create an application that works for connections that aren’t peer-to-peer, create a protocol fallback to client-server RTMP and/or RTMPT. To create an application that never relays media through the server (even though some clients may not see the media), don’t create a protocol fallback</p>

<p><strong>理解NAT的类型</strong></p>

<p><strong>Cone</strong>    当想所有节点说话时重用同样的地址和端口</p>

<p>多 IP地址，对称的    向一个新节点说话时，使用新地址和端口</p>

<p>单一 IP地址，对称的 向一个新节点说话时，使用相同的地址和端口</p>

<p>理解NAT和防火墙的过滤行为很重要：</p>

<p>None    没有过滤功能的叫&quot;full cone&quot;</p>

<p>Address-restricted  节点限制在已经使用过的地址</p>

<p>Address and port-restricted 节点限制在已经使用过的地址和端口</p>

<p>In addition, some NAT and firewall behaviors aren&#39;t easily defined. For example, a NAT could act as a symmetric NAT that preserves port numbers. When it runs out of resources, it could switch and act as a cone NAT.</p>

<p>In another example, a NAT could act as one type of NAT for the first client that connected to a server. It could act as a different type of NAT for the second client that tried to connect to the same server. In this case, a simple analysis can fail to predict whether a client can make a peer-to-peer connection.</p>

<p><strong>RTMFP连接检查</strong></p>

<p>RTMFP发明家马修·考夫曼主持一个名为RTMFP连通性检查程序的网站http://cc.rtmfp.net/。使用这个网站,尝试确定一个客户机在一个特定的网络可以创建一个点对点连接。</p>

<p><strong>为HTTP流配置端口</strong></p>

<h6>负载平衡</h6>

<p><strong>部署服务器集群的工作流</strong></p>

<hr>

<p><strong>点对点网络应用的负载均衡</strong></p>

<h6>部署边缘服务器</h6>

<p><strong>部署边缘服务器的工作流</strong></p>

<p><strong>设置边缘服务器的缓存</strong></p>

<p><strong>连接到一个边缘服务器</strong></p>

<h6>部署64位服务器</h6>

<h5>第二章、配置服务器</h5>

<h6>配置服务器虚拟映射</h6>

<h6>使用配置文件</h6>

<h6>配置性能特性</h6>

<h6>配置安全特性</h6>

<h6>执行常规配置任务</h6>

<h6>配置内容存储</h6>

<h6>配置Apache HTTP服务器</h6>

<h6>为Adobe HTTP动态流和Apple HTTP 实时流配置Apache</h6>

<h6>配置HTTP流失效备援</h6>

<h6>使用第三方的web服务器</h6>

<h6>配置差分服务(DiffServ)</h6>

<h5>第三章、使用管理员控制台</h5>

<h6>连接管理员控制台</h6>

<h6>检查应用</h6>

<h6>管理管理员</h6>

<h6>管理服务器</h6>

<h5>第四章、监控和管理日志文件</h5>

<h6>使用日志文件</h6>

<h6>访问日志</h6>

<h6>应用日志</h6>

<h6>诊断日志</h6>

<h5>第五章、管理服务器</h5>

<h6>开始和停止服务器</h6>

<h6>检查服务器状态</h6>

<h6>检查视频文件</h6>

<h6>在Linux上管理服务器</h6>

<h6>Scramble tool</h6>

<h5>第六章、使用管理员API</h5>

<h6>使用管理员API工作</h6>

<h5>第七章、XML配置文件参考</h5>

<h6>配置文件的版本从4.5到5.0.1发生的改变</h6>

<h6>配置文件的版本从4.0到4.5发生的改变</h6>

<h6>Adaptor.xml文件</h6>

<h6>Application.xml文件</h6>

<h6>Logger.xml文件</h6>

<h6>Server.xml文件</h6>

<h6>Users.xml文件</h6>

<h6>VHost.xml文件</h6>

<h5>第八章、诊断日志消息</h5>

<h6>诊断日志的消息ID</h6>


  <address class="signature">
    <a class="author" href="/">lsj</a> 
    <span class="date">03 July 2014</span>
    <span class="location"></span>
  </address>
  
  
	<div class='cloud'>
		<a style='font-size: 112%' href='/tags.html#crack'>crack</a>
<a style='font-size: 161%' href='/tags.html#actionscript'>actionscript</a>
<a style='font-size: 70%' href='/tags.html#ios'>ios</a>
<a style='font-size: 112%' href='/tags.html#swf'>swf</a>
<a style='font-size: 70%' href='/tags.html#air'>air</a>
<a style='font-size: 131%' href='/tags.html#essential actionscript3.0'>essential actionscript3.0</a>
<a style='font-size: 70%' href='/tags.html#java'>java</a>
<a style='font-size: 96%' href='/tags.html#android'>android</a>
<a style='font-size: 112%' href='/tags.html#stock'>stock</a>
<a style='font-size: 170%' href='/tags.html#fms'>fms</a>
<a style='font-size: 70%' href='/tags.html#vim'>vim</a>
<a style='font-size: 70%' href='/tags.html#p2p'>p2p</a>
<a style='font-size: 70%' href='/tags.html#error'>error</a>

	</div>
	
  <div class="prev-next">
  
    <a href="/fms/2014/07/04/communication-between-client-and-server" class="next" title="communication between client and server">Next Post &rarr;</a>
  
  
    <a href="/fms/2014/07/01/server-side-actionscript-language-reference" class="prev" title="server side actionscript language reference">&larr; Earlier Post</a>
  
  </div>
  
</div><!-- End Page -->

	




  <!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1926112"></script>
<!-- UY END -->





  
  <div id="footer">
  	<address>
  		<span class="copyright">
  			Content by <a href="/info/site.html">lsj</a>. Design by 
  			<a href="http://mark.reid.name/">Mark Reid</a>
  			<br/>
  			(<a rel="licence" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Some rights reserved</a>)			
  		</span>
  		<span class="engine">
  			Powered by <a href="http://github.com/mojombo/jekyll/" title="A static, minimalist CMS">Jekyll</a>
  		</span>
  	</address>
  </div>
  
</div>



<!--[if IE 6]>
<script type="text/javascript"> 
	/*Load jQuery if not already loaded*/ if(typeof jQuery == 'undefined'){ document.write("<script type=\"text/javascript\"   src=\"http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js\"></"+"script>"); var __noconflict = true; } 
	var IE6UPDATE_OPTIONS = {
		icons_path: "http://static.ie6update.com/hosted/ie6update/images/"
	}
</script>
<script type="text/javascript" src="http://static.ie6update.com/hosted/ie6update/ie6update.js"></script>
<![endif]-->

  
  


<script type="text/javascript"> 
<!-- 
(function(){ 
var S=navigator.userAgent.indexOf("MSIE")!=-1&&!window.opera; 
function M(C){ 
return document.getElementById(C) 
} function R(C){ 
return document.createElement(C) 
} var P=[19416,19168,42352,21717,53856,55632,91476,22176,39632,21970,19168,42422,42192,53840,119381,46400,54944,44450,38320,84343,18800,42160,46261,27216,27968,109396,11104,38256,21234,18800,25958,54432,59984,28309,23248,11104,100067,37600,116951,51536,54432,120998,46416,22176,107956,9680,37584,53938,43344,46423,27808,46416,86869,19872,42448,83315,21200,43432,59728,27296,44710,43856,19296,43748,42352,21088,62051,55632,23383,22176,38608,19925,19152,42192,54484,53840,54616,46400,46496,103846,38320,18864,43380,42160,45690,27216,27968,44870,43872,38256,19189,18800,25776,29859,59984,27480,21952,43872,38613,37600,51552,55636,54432,55888,30034,22176,43959,9680,37584,51893,43344,46240,47780,44368,21977,19360,42416,86390,21168,43312,31060,27296,44368,23378,19296,42726,42208,53856,60005,54576,23200,30371,38608,19415,19152,42192,118966,53840,54560,56645,46496,22224,21938,18864,42359,42160,43600,111189,27936,44448]; 
var K="甲乙丙丁戊己庚辛壬癸"; 
var J="子丑寅卯辰巳午未申酉戌亥"; 
var O="鼠牛虎兔龙蛇马羊猴鸡狗猪"; 
var L=["小寒","大寒","立春","雨水","惊蛰","春分","清明","谷雨","立夏","小满","芒种","夏至","小暑","大暑","立秋","处暑","白露","秋分","寒露","霜降","立冬","小雪","大雪","冬至"]; 
var D=[0,21208,43467,63836,85337,107014,128867,150921,173149,195551,218072,240693,263343,285989,308563,331033,353350,375494,397447,419210,440795,462224,483532,504758]; 
var B="日一二三四五六七八九十"; 
var H=["正","二","三","四","五","六","七","八","九","十","十一","腊"]; 
var E="初十廿卅"; 
var V={ 
"0101":"*1元旦节","0214":"情人节","0305":"学雷锋纪念日","0308":"妇女节","0312":"植树节","0315":"消费者权益日","0401":"愚人节","0501":"*1劳动节","0504":"青年节","0601":"国际儿童节","0701":"中国共产党诞辰","0801":"建军节","0910":"中国教师节","1001":"*3国庆节","1224":"平安夜","1225":"圣诞节" 
} ; 
var T={ 
"0101":"*2春节","0115":"元宵节","0505":"*1端午节","0815":"*1中秋节","0909":"重阳节","1208":"腊八节","0100":"除夕" 
} ; 
function U(Y){ 
function c(j,i){ 
var h=new Date((31556925974.7*(j-1900)+D[i]*60000)+Date.UTC(1900,0,6,2,5)); 
return(h.getUTCDate()) 
} function d(k){ 
var h,j=348; 
for(h=32768;h>8;h>>=1){ 
j+=(P[k-1900]&h)?1:0 
} return(j+b(k)) 
} function a(h){ 
return(K.charAt(h%10)+J.charAt(h%12)) 
} function b(h){ 
if(g(h)){ 
return((P[h-1900]&65536)?30:29) 
} else{ 
return(0) 
} 
} function g(h){ 
return(P[h-1900]&15) 
} function e(i,h){ 
return((P[i-1900]&(65536>>h))?30:29) 
} function C(m){ 
var k,j=0,h=0; 
var l=new Date(1900,0,31); 
var n=(m-l)/86400000; 
this.dayCyl=n+40; 
this.monCyl=14; 
for(k=1900;k<2050&&n>0;k++){ 
h=d(k); 
n-=h; 
this.monCyl+=12 
} if(n<0){ 
n+=h; 
k--; 
this.monCyl-=12 
} this.year=k; 
this.yearCyl=k-1864; 
j=g(k); 
this.isLeap=false; 
for(k=1;k<13&&n>0;k++){ 
if(j>0&&k==(j+1)&&this.isLeap==false){ 
--k; 
this.isLeap=true; 
h=b(this.year) 
} else{ 
h=e(this.year,k) 
} if(this.isLeap==true&&k==(j+1)){ 
this.isLeap=false 
} n-=h; 
if(this.isLeap==false){ 
this.monCyl++ 
} 
} if(n==0&&j>0&&k==j+1){ 
if(this.isLeap){ 
this.isLeap=false 
} else{ 
this.isLeap=true; 
--k; 
--this.monCyl 
} 
} if(n<0){ 
n+=h; 
--k; 
--this.monCyl 
} this.month=k; 
this.day=n+1 
} function G(h){ 
return h<10?"0"+h:h 
} function f(i,j){ 
var h=i; 
return j.replace(/dd?d?d?|MM?M?M?|yy?y?y?/g,function(k){ 
switch(k){ 
case"yyyy":var l="000"+h.getFullYear(); 
return l.substring(l.length-4); 
case"dd":return G(h.getDate()); 
case"d":return h.getDate().toString(); 
case"MM":return G((h.getMonth()+1)); 
case"M":return h.getMonth()+1 
} 
} ) 
} function Z(i,h){ 
var j; 
switch(i,h){ 
case 10:j="初十"; 
break; 
case 20:j="二十"; 
break; 
case 30:j="三十"; 
break; 
default:j=E.charAt(Math.floor(h/10)); 
j+=B.charAt(h%10) 
} return(j) 
} this.date=Y; 
this.isToday=false; 
this.isRestDay=false; 
this.solarYear=f(Y,"yyyy"); 
this.solarMonth=f(Y,"M"); 
this.solarDate=f(Y,"d"); 
this.solarWeekDay=Y.getDay(); 
this.solarWeekDayInChinese="星期"+B.charAt(this.solarWeekDay); 
var X=new C(Y); 
this.lunarYear=X.year; 
this.shengxiao=O.charAt((this.lunarYear-4)%12); 
this.lunarMonth=X.month; 
this.lunarIsLeapMonth=X.isLeap; 
this.lunarMonthInChinese=this.lunarIsLeapMonth?"闰"+H[X.month-1]:H[X.month-1]; 
this.lunarDate=X.day; 
this.showInLunar=this.lunarDateInChinese=Z(this.lunarMonth,this.lunarDate); 
if(this.lunarDate==1){ 
this.showInLunar=this.lunarMonthInChinese+"月" 
} this.ganzhiYear=a(X.yearCyl); 
this.ganzhiMonth=a(X.monCyl); 
this.ganzhiDate=a(X.dayCyl++); 
this.jieqi=""; 
this.restDays=0; 
if(c(this.solarYear,(this.solarMonth-1)*2)==f(Y,"d")){ 
this.showInLunar=this.jieqi=L[(this.solarMonth-1)*2] 
} if(c(this.solarYear,(this.solarMonth-1)*2+1)==f(Y,"d")){ 
this.showInLunar=this.jieqi=L[(this.solarMonth-1)*2+1] 
} if(this.showInLunar=="清明"){ 
this.showInLunar="清明节"; 
this.restDays=1 
} this.solarFestival=V[f(Y,"MM")+f(Y,"dd")]; 
if(typeof this.solarFestival=="undefined"){ 
this.solarFestival="" 
} else{ 
if(/\*(\d)/.test(this.solarFestival)){ 
this.restDays=parseInt(RegExp.$1); 
this.solarFestival=this.solarFestival.replace(/\*\d/,"") 
} 
} this.showInLunar=(this.solarFestival=="")?this.showInLunar:this.solarFestival; 
this.lunarFestival=T[this.lunarIsLeapMonth?"00":G(this.lunarMonth)+G(this.lunarDate)]; 
if(typeof this.lunarFestival=="undefined"){ 
this.lunarFestival="" 
} else{ 
if(/\*(\d)/.test(this.lunarFestival)){ 
this.restDays=(this.restDays>parseInt(RegExp.$1))?this.restDays:parseInt(RegExp.$1); 
this.lunarFestival=this.lunarFestival.replace(/\*\d/,"") 
} 
} if(this.lunarMonth==12&&this.lunarDate==e(this.lunarYear,12)){ 
this.lunarFestival=T["0100"]; 
this.restDays=1 
} this.showInLunar=(this.lunarFestival=="")?this.showInLunar:this.lunarFestival; 
this.showInLunar=(this.showInLunar.length>4)?this.showInLunar.substr(0,2)+"...":this.showInLunar 
} var Q=(function(){ 
var X={ 
} ; 
X.lines=0; 
X.dateArray=new Array(42); 
function Y(a){ 
return(((a%4===0)&&(a%100!==0))||(a%400===0)) 
} function G(a,b){ 
return[31,(Y(a)?29:28),31,30,31,30,31,31,30,31,30,31][b] 
} function C(a,b){ 
a.setDate(a.getDate()+b); 
return a 
} function Z(a){ 
var f=0; 
var c=new U(new Date(a.solarYear,a.solarMonth-1,1)); 
var d=(c.solarWeekDay-1==-1)?6:c.solarWeekDay-1; 
X.lines=Math.ceil((d+G(a.solarYear,a.solarMonth-1))/7); 
for(var e=0;e<X.dateArray.length;e++){ 
if(c.restDays!=0){ 
f=c.restDays 
} if(f>0){ 
c.isRest=true 
} if(d-->0||c.solarMonth!=a.solarMonth){ 
X.dateArray[e]=null; 
continue 
} var b=new U(new Date()); 
if(c.solarYear==b.solarYear&&c.solarMonth==b.solarMonth&&c.solarDate==b.solarDate){ 
c.isToday=true 
} X.dateArray[e]=c; 
c=new U(C(c.date,1)); 
f-- 
} 
} return{ 
init:function(a){ 
Z(a) 
} ,getJson:function(){ 
return X 
} 
} 
} )(); 
var W=(function(){ 
var C=M("top").getElementsByTagName("SELECT")[0]; 
var X=M("top").getElementsByTagName("SELECT")[1]; 
var G=M("top").getElementsByTagName("SPAN")[0]; 
var c=M("top").getElementsByTagName("SPAN")[1]; 
var Y=M("top").getElementsByTagName("INPUT")[0]; 
function a(g){ 
G.innerHTML=g.ganzhiYear; 
c.innerHTML=g.shengxiao 
} function b(g){ 
C[g.solarYear-1901].selected=true; 
X[g.solarMonth-1].selected=true 
} function f(){ 
var j=C.value; 
var g=X.value; 
var i=new U(new Date(j,g-1,1)); 
Q.init(i); 
N.draw(); 
if(this==C){ 
i=new U(new Date(j,3,1)); 
G.innerHTML=i.ganzhiYear; 
c.innerHTML=i.shengxiao 
} var h=new U(new Date()); 
Y.style.visibility=(j==h.solarYear&&g==h.solarMonth)?"hidden":"visible" 
} function Z(){ 
var g=new U(new Date()); 
a(g); 
b(g); 
Q.init(g); 
N.draw(); 
Y.style.visibility="hidden" 
} function d(k,g){ 
for(var j=1901;j<2050;j++){ 
var h=R("OPTION"); 
h.value=j; 
h.innerHTML=j; 
if(j==k){ 
h.selected="selected" 
} C.appendChild(h) 
} for(var j=1;j<13;j++){ 
var h=R("OPTION"); 
h.value=j; 
h.innerHTML=j; 
if(j==g){ 
h.selected="selected" 
} X.appendChild(h) 
} C.onchange=f; 
X.onchange=f 
} function e(g){ 
d(g.solarYear,g.solarMonth); 
G.innerHTML=g.ganzhiYear; 
c.innerHTML=g.shengxiao; 
Y.onclick=Z; 
Y.style.visibility="hidden" 
} return{ 
init:function(g){ 
e(g) 
} ,reset:function(g){ 
b(g) 
} 
} 
} )(); 
var N=(function(){ 
function C(){ 
var Z=Q.getJson(); 
var c=Z.dateArray; 
M("cm").style.height=Z.lines*38+2+"px"; 
M("cm").innerHTML=""; 
for(var a=0;a<c.length;a++){ 
if(c[a]==null){ 
continue 
} var X=R("DIV"); 
if(c[a].isToday){ 
X.style.border="1px solid #a5b9da"; 
X.style.background="#c1d9ff" 
} X.className="cell"; 
X.style.left=(a%7)*34+"px"; 
X.style.top=Math.floor(a/7)*38+2+"px"; 
var b=R("DIV"); 
b.className="so"; 
// http://www.codefans.net 
b.style.color=((a%7)>4||c[a].isRest)?"#c60b02":"#313131"; 
b.innerHTML=c[a].solarDate; 
X.appendChild(b); 
var Y=R("DIV"); 
Y.style.color="#666"; 
Y.innerHTML=c[a].showInLunar; 
X.appendChild(Y); 
X.onmouseover=(function(d){ 
return function(f){ 
F.show({ 
dateIndex:d,cell:this 
} ) 
} 
} )(a); 
X.onmouseout=function(){ 
F.hide() 
} ; 
M("cm").appendChild(X) 
} var G=R("DIV"); 
G.id="fd"; 
M("cm").appendChild(G); 
F.init(G) 
} return{ 
draw:function(G){ 
C(G) 
} 
} 
} )(); 
var F=(function(){ 
var C; 
function Y(e,c){ 
if(arguments.length>1){ 
var b=/([.*+?^=!:${}()|[\]\/\\])/g,Z="{".replace(b,"\\$1"),d="}".replace(b,"\\$1"); 
var a=new RegExp("#"+Z+"([^"+Z+d+"]+)"+d,"g"); 
if(typeof (c)=="object"){ 
return e.replace(a,function(f,h){ 
var g=c[h]; 
return typeof (g)=="undefined"?"":g 
} ) 
} 
} return e 
} function G(b){ 
var a=Q.getJson().dateArray[b.dateIndex]; 
var Z=b.cell; 
var c="#{solarYear} 年 #{solarMonth} 月 #{solarDate} 日 #{solarWeekDayInChinese}"; 
c+="<br><b> #{lunarMonthInChinese}月#{lunarDateInChinese}</b>"; 
c+="<br>#{ganzhiYear}年 #{ganzhiMonth}月 #{ganzhiDate}日"; 
if(a.solarFestival!=""||a.lunarFestival!=""||a.jieqi!=""){ 
c+="<br><b>#{lunarFestival} #{solarFestival} #{jieqi}</b>" 
} C.innerHTML=Y(c,a); 
C.style.top=Z.offsetTop+Z.offsetHeight-5+"px"; 
C.style.left=Z.offsetLeft+Z.offsetWidth-5+"px"; 
C.style.display="block" 
} function X(){ 
C.style.display="none" 
} return{ 
show:function(Z){ 
G(Z) 
} ,hide:function(){ 
X() 
} ,init:function(Z){ 
C=Z 
} 
} 
} )(); 
var A=new U(new Date()); 
if(S){ 
window.attachEvent("onload",function(){ 
W.reset(A) 
} ) 
} W.init(A); 
Q.init(A); 
N.draw(); 
} )(); 
//--> 
</script>
  
</body>
</html>

