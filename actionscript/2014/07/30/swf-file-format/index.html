
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>swf文件格式  </title>
   <meta name="author" content="lsj" />

   <link rel="start" href="/" />

	
	
	
  	<link rel="alternate" type="application/atom+xml" href="http://feeds.feedburner.com/feedname" title="RSS feed" />
	
	

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/assets/themes/mark-reid/css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/assets/themes/mark-reid/css/screen.css" type="text/css" />


	
</head>

<body id="">

<div id="header" >
    <h1>
    	<a href="/" title="alonepig's blog" >alonepig's blog</a>
		<!--     	<span class="byline">&larr; <a href="/">lsj</a></span> -->
    </h1>
    <ul class="nav">
      <li><a class="home" href="/">Home</a></li>
      <li><a  href="/archive.html">Archive</a></li>
      <li><a  href="/pages.html">Pages</a></li>
      <li><a  href="/categories.html">Categories</a></li>
      <li><a  href="/tags.html">Tags</a></li>
      <li><a  href="/about.html">About</a></li>
    </ul>
  </div>
</div>

<div id="left">

     <strong>Tag Clound</strong>
     <br />
     <div class="navbar1" >
     	
    		<a href="tags.html#fms-ref" id="1" class="__tag" style="margin: 5px">fms</a>
  		
    		<a href="tags.html#air-ref" id="2" class="__tag" style="margin: 5px">air</a>
  		
    		<a href="tags.html#ios-ref" id="3" class="__tag" style="margin: 5px">ios</a>
  		
    		<a href="tags.html#actionscript-ref" id="4" class="__tag" style="margin: 5px">actionscript</a>
  		
    		<a href="tags.html#error-ref" id="5" class="__tag" style="margin: 5px">error</a>
  		
    		<a href="tags.html#swf-ref" id="6" class="__tag" style="margin: 5px">swf</a>
  		
    		<a href="tags.html#crack-ref" id="7" class="__tag" style="margin: 5px">crack</a>
  		
    		<a href="tags.html#vim-ref" id="8" class="__tag" style="margin: 5px">vim</a>
  		
     </div>
     
     
     <strong>Calendar</strong>
      
     <div class="navbar1" >
     <table cellpadding="0" cellspacing="0" id="1" > 
		<tr> 
		<td><style> 
body,td,.p1,.p2,.i{font-family:arial} 
body{margin:0 0 0 0;background-color:#fff;color:#000;} 
table{border:0} 
#cal{width:100%;border:1px solid #c3d9ff;font-size:12px;margin:0px 0 0 0px} 
#cal #top{height:29px;line-height:29px;background:#e7eef8;color:#003784;padding-left:0px} 
#cal #top select{font-size:12px} 
#cal #top input{padding-right: 0px; right: 0px} 
#cal ul#wk{margin:0;padding:0;height:25px} 
#cal ul#wk li{float:left;width:34.5px;text-align:center;line-height:25px;list-style:none} 
#cal ul#wk li b{font-weight:normal;color:#c60b02} 
#cal #cm{clear:left;border-top:1px solid #ddd;border-bottom:1px dotted #ddd;position:relative} 
#cal #cm .cell{position:absolute;width:42px;height:36px;text-align:center;margin:0 0 0 0px} 
#cal #cm .cell .so{font:bold 16px arial;} 
#cal #bm{text-align:right;height:24px;line-height:24px;padding:0 13px 0 0} 
#cal #bm a{color:7977ce} 
#cal #fd{display:none;position:absolute;border:1px solid #dddddf;background:#feffcd;padding:10px;line-height:21px;width:150px} 
#cal #fd b{font-weight:normal;color:#c60a00} 
</style> 
<!--[if IE]> 
<style> 
#cal #top{padding-top:4px} 
#cal #top input{width:65px} 
#cal #fd{width:170px} 
</style> 
<![endif]--> 
		<div id="cal">
			<div id="top">
				<select>
				</select> 年 <select>
				</select> 月 <span></span> [ <span></span>年 ] <input type="button"
					value="今天" title="点击后跳转回今天" style="padding: 0px">
			</div>
			<ul id="wk">
				<li>一</li>
				<li>二</li>
				<li>三</li>
				<li>四</li>
				<li>五</li>
				<li><b>六</b></li>
				<li><b>日</b></li>
			</ul>
			<div id="cm"></div>
			<div id="bm"></div>
		</div>
		</td>
		</tr>
		</table>
     </div>
     
     
<!-- 	<strong>Blogroll</strong><br /> -->
<!-- 	<div class="navbar1" > -->
<!--      	<ul > -->
<!--      		<li><a href="" target="_blank" ><span >github.com</span></a></li> -->
<!--      	</ul> -->
<!-- 	</div> -->
	
	<!--
	<strong>Find Me</strong><br />
	<div class="navbar1" >
	<ul >
          <li><a href="https://github.com/alonepig" target="_blank" title="Github"><span class="fa fa-github fa-lg">Github</span></a></li>
          <li><a href="http://www.douban.com/people/alonepig" target="_blank" title="douban"><span>豆瓣</span></a></li>
          <li><a href="http://www.zhihu.com/people/alonepig" target="_blank" ><span>知乎</span></a></li>
     </ul>
     </div>
     
     -->
</div>


<div id="site">
  
  
<div id="page">
	
  <h1 class="emphnext">swf文件格式</h1>
  <ul class="tag_box inline">
  
  


  
     
    	<li><a href="/tags.html#swf-ref">swf <span>3</span></a></li>
     
    	<li><a href="/tags.html#crack-ref">crack <span>3</span></a></li>
     
    	<li><a href="/tags.html#actionscript-ref">actionscript <span>5</span></a></li>
    
  



  </ul>

  <p>关于swf的文件格式，除了官方的文档，也有许多的资料可以参考。在这里只是做一个总结，具体内容请参阅最后给出的链接。</p>

<p>学习swf的格式，首先你要了解swf的组成，它是有许多的标签按照一定的规则构成。它有自己定义的单位，就像int、number一样。可以查阅官方的文档或http://www.the-labs.com/MacromediaFlash/SWF-Spec/SWFfilereference.html来了解基本的数据类型和标签类型。</p>

<p>到最新的版本，已有的标签如下：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Tag-value     Tag-name
0            End
1         ShowFrame
2         DefineShape
4         PlaceObject
5         RemoveObject
6         DefineBits
7         DefineButton
8         JPEGTables
9         SetBackgroundColor
10     DefineFont
11     DefineText
12     DoAction
13     DefineFontInfo
14     DefineSound
15     StartSound
17     DefineButtonSound
18     SoundStreamHead
19     SoundStreamBlock
20     DefineBitsLossless
21     DefineBitsJPEG2
22     DefineShape2
23     DefineButtonCxform
24     Protect
26     PlaceObject2
28     RemoveObject2
32     DefineShape3
33     DefineText2
34     DefineButton2
35     DefineBitsJPEG3
36     DefineBitsLossless2
37     DefineEditText
39     DefineSprite
43     FrameLabel
45     SoundStreamHead2
46     DefineMorphShape
48     DefineFont2
56     ExportAssets
57     ImportAssets
58     EnableDebugger
59     DoInitAction
60     DefineVideoStream
61     VideoFrame
62     DefineFontInfo2
64     EnableDebugger2
65     ScriptLimits
66     SetTabIndex
69     FileAttributes
70     PlaceObject3
71     ImportAssets2
73     DefineFontAlignZones
74     CSMTextSettings
75     DefineFont3
76     SymbolClass
77     Metadata
78     DefineScalingGrid
82     DoABC
83     DefineShape4
84     DefineMorphShape2
86     DefineSceneAndFrameLabelData
87     DefineBinaryData
88     DefineFontName
89     StartSound2
90     DefineBitsJPEG4
91     DefineFont4
</code></pre></div>
<p>然后，你需要弄明白这个规则。swf是由头和身体两部分组成。</p>

<p>参考(A simple .swf file and it’s below the line representation)[http://blog.csdn.net/qdlgx/article/details/2868504]，你将明白头是怎么构成的，标签又是按照什么顺序排列的。</p>

<p>再然后，就是指令集了。AVM虚拟机有自己的指令集。详情参考http://www.adobe.com/content/dam/Adobe/en/devnet/actionscript/articles/avm2overview.pdf</p>

<p>下面总结出的ABC文件结构：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">abcFile
{
+ minor_version: u16    最低swf版本
+ major_version: u16    最高swf版本
+ method_count: u30     方法数量
+ metadata_count: u30   元数据数量
+ class_count: u30          类数量
+ script_count: u30         脚本数量
+ method_body_count: u30      方法体数量
+ constant_pool: cpool_info      常量池
+ method: method_info (Array)      方法集合
+ metadata: metadata_info (Array)      元数据集合
+ instance: instance_info (Array)      实例集合
+ class: class_info (Array)      类集合
+ script: script_info (Array)      脚本集合
+ method_body: method_body_info (Array)      方法体集合
}



cpool_info
{
+ int_count: u30      整形数量
+ uint_count: u30      无符号整形数量
+ double_count: u30      双精度型数量     
+ string_count: u30      字符串数量
+ namespace_count: u30      命名空间数量
+ ns_set_count: u30      命名空间集合数量
+ multiname_count: u30      复合名字数量
+ string: string_info (Array)      字符串集合
+ namespace: namespace_info (Array)      命名空间集合
+ ns_set: ns_set_info (Array)      命名空间的集合关系
+ multiname: multiname_info (Array)      复合名字集合
}

namespace_info
{
+ CONSTANT_Namespace: u8 = 0x08
+ CONSTANT_PackageNamespace: u8 = 0x16
+ CONSTANT_PackageInternalNs: u8 = 0x17
+ CONSTANT_ProtectedNamespace: u8 = 0x18
+ CONSTANT_ExplicitNamespace: u8 = 0x19
+ CONSTANT_StaticProtectedNs: u8 = 0x1A
+ CONSTANT_PrivateNs: u8 = 0x05
+ kind: u8      类型，有6种常量类型
+ name：u30      string集合的下标，为0的话则是空字符串
}

ns_set_info
{
+ count: u30      数量
+ ns: u30 (Array)      each ns is an integer that indexes into the namespace array of the constant pool
}

multiname_info
{
+ kind: u8      类型
+ CONSTANT_QName: u8 = 0x07
+ CONSTANT_QNameA: u8 = 0x0D
+ CONSTANT_RTQName: u8 = 0x0F
+ CONSTANT_RTQNameA: u8 = 0x10
+ CONSTANT_RTQNameL: u8 = 0x11
+ CONSTANT_RTQNameLA: u8 = 0x12
+ CONSTANT_Multiname: u8 = 0x09
+ CONSTANT_MultinameA: u8 = 0x0E
+ CONSTANT_MultinameL: u8 = 0x1B
+ CONSTANT_MultinameLA: u8 = 0x1C
+ data: u8 (Array)      可变长数据(根据不同类型得到不同的数据)
}

multiname_kind_QName
{
+ ns: u30      namespace集合的索引
+ name: u30      string集合的索引
}

multiname_kind_RTQName
{
+ name: u30      string集合的索引
}

multiname_kind_RTQNameL
{
}

multiname_kind_Multiname
{
+ u30 name      string集合的索引
+ u30 ns_set      ns_set集合的索引
}

multiname_kind_MultinameL
{
+ u30 ns_set      ns_set集合的索引
}


method_info
{
+ u30 param_count      参数的数量
+ u30 return_type      指向multiname索引
+ u30 param_type[param_count]      每一个条目指向multiname集合的索引
+ u30 name      string集合的索引
+ u8 flags      为以下常量类型，提供关于方法的额外信息
+ option_info options      只有在flag为HAS_OPTIONAL时才会出现
+ param_info param_names      只有在flag为HAS_PARAM_NAMES才会出现
+ NEED_ARGUMENTS: u8 = 0x01      Suggests to the run-time that an “arguments” object (as specified by the ActionScript 3.0 Language Reference) be created. Must not be used together with NEED_REST
+ NEED_ACTIVATION: u8 = 0x02      Must be set if this method uses the newactivation opcode
+ NEED_REST: u8 = 0x04      This flag creates an ActionScript 3.0 rest arguments array. Must not be used with NEED_ARGUMENTS
+ HAS_OPTIONAL: u8 = 0x08      Must be set if this method has optional parameters and the options field is present in this method_info structure
+ SET_DXNS: u8 = 0x40      Must be set if this method has optional parameters and the options field is present in this method_info structure
+ HAS_PARAM_NAMES: u8 = 0x80      Must be set when the param_names field is present in this method_info structure
}

option_info
{
+ u30 option_count
+ option_detail option[option_count]
}

option_detail
{
+ u30 val      有kind类型来指向常量池中不同类型集合的索引，如0x03表示整形集合的索引
+ u8 kind      类型，对应kind_constants
}

kind_constants
{
+ CONSTANT_Int: u8 = 0x03
+ CONSTANT_UInt: u8 = 0x04
+ CONSTANT_Double: u8 = 0x06
+ CONSTANT_Utf8: u8 = 0x01
+ CONSTANT_True: u8 = 0x0B
+ CONSTANT_False: u8 = 0x0A
+ CONSTANT_Null: u8 = 0x0C
+ CONSTANT_Undefined: u8 = 0x00
+ CONSTANT_Namespace: u8 = 0x08
+ CONSTANT_PackageNamespace: u8 = 0x16
+ CONSTANT_PackageInternalNs: u8 = 0x17
+ CONSTANT_ProtectedNamespace: u8 = 0x18
+ CONSTANT_ExplicitNamespace: u8 = 0x19
+ CONSTANT_StaticProtectedNs: u8 = 0x1A
+ CONSTANT_PrivateNs: u8 = 0x05
}


metadata_info
{
+ u30 name      string集合的索引
+ u30 item_count      items条目的数量
+ item_info items[item_count]      
}

item_info
{
+ u30 key
+ u30 value
}
The item_info entry consists of item_count elements that are interpreted as key/value pairs of indices into the string table of the constant pool


instance_info
{
+ CONSTANT_ClassSealed: u8 = 0x01      The class is sealed: properties can not be dynamically added to instances of the class
+ CONSTANT_ClassFinal: u8 = 0x02      The class is final: it cannot be a base class for any other class
+ CONSTANT_ClassInterface: u8 = 0x04      The class is an interface
+ CONSTANT_ClassProtectedNs: u8 = 0x08      The class uses its protected namespace and the protectedNs field is present in the interface_info structure
+ u30 name      multiname索引，类名
+ u30 super_name      基类的名字，multiname索引
+ u8 flags      常量类型
+ u30 protectedNs      flags为CONSTANT_ClassProtectedNs时才出现， namespace索引
+ u30 intrf_count      interface长度
+ u30 interface[intrf_count]      interface的条目包含multiname索引
+ u30 iinit      abcFile中method的索引
+ u30 trait_count      trait长度
+ traits_info trait[trait_count]      
}

traits_info
{
+ Trait_Slot: u8 = 0
+ Trait_Method: u8 = 1
+ Trait_Getter: u8 = 2
+ Trait_Setter: u8 = 3
+ Trait_Class: u8 = 4
+ Trait_Function: u8 = 5
+ Trait_Const: u8 = 6
+ ATTR_Final: u8 = 0x1
+ ATTR_Override: u8 = 0x2
+ ATTR_Metadata: u8 = 0x4
+ name: u30      multiname索引，不能为0
+ kind: u8      两个四位字段，低四位决定trait的类型，高四位构成trait的属性(有点不明白)
+ data: u8 (Array)      有trait的类型决定
+ metadata_count: u30      metadata长度
+ metadata: u30 (Array)      
}

trait_slot
{
+ u30 slot_id
+ u30 type_name      multiname索引
+ u30 vindex      
+ u8 vkind      kind_constant索引，当vindex不为0时存在
}
Trait_Slot或Trait_Const类型为trait_slot


trait_class
{
+ u30 slot_id      确定trait的位置
+ u30 classi      abcFile的class集合索引
}
Trait_Class类型为trait_class

trait_function
{
+ u30 slot_id
+ u30 function      abcFile中method索引
}
Trait_Function类型为trait_function

trait_method
{
+ u30 disp_id
+ u30 method      abcFile中method索引
}
Trait_Method、Trait_Getter、Trait_Setter类型为trai_method


class_info
{
+ u30 cinit      method索引
+ u30 trait_count
+ traits_info traits[trait_count]
}

script_info
{
+ u30 init      method索引
+ u30 trait_count
+ traits_info trait[trait_count]
}


method_body_info
{
+ method: u30      abcFile中method索引
+ max_stack: u30
+ local_count: u30      最大本地寄存器索引+1
+ init_scope_depth: u30
+ max_scope_depth: u30
+ code_length: u30
+ code: u8      保存AVM2指令
+ exception_count: u30
+ exception: exception_info (Array)
+ trait_count: u30
+ trait: traits_info (Array)
}

exception_info
{
+ u30 from      代码范围
+ u30 to
+ u30 target      跳转目标
+ u30 exc_type      错误类型, 常量表中 string 索引, 0=所有错误
+ u30 var_name      异常的变量名, 常量表中 string 索引
}
</code></pre></div>
<p>授之以鱼不如授之以渔，由于自己的水平有限，也没有完成弄懂里面的所有东西。在此，只是记录自己的学习过程。除了下面参考的资料，个人觉得最好的学习方法还是找到一个比较好的解析swf开源项目，通过阅读源码来理解(可参考swfinvestigator、as3crypto、JPEXS等)。有任何问题，欢迎跟我探讨。</p>

<p>参考：</p>

<p><a href="http://www.the-labs.com/MacromediaFlash/SWF-Spec/SWFfilereference.html">SWF File Reference</a></p>

<p><a href="http://www.the-labs.com/MacromediaFlash/SWF-Spec/SWFfileformat.html">SWF File Format Specification</a></p>

<p><a href="http://www.adobe.com/content/dam/Adobe/en/devnet/actionscript/articles/avm2overview.pdf">AVM指令集概要</a></p>

<p><a href="http://blog.csdn.net/qdlgx/article/details/2868504">一个例子分析swf格式</a></p>


  <address class="signature">
    <a class="author" href="/">lsj</a> 
    <span class="date">30 July 2014</span>
    <span class="location"></span>
  </address>
  
  
	<div class='cloud'>
		<a style='font-size: 113%' href='/tags.html#swf'>swf</a>
<a style='font-size: 70%' href='/tags.html#air'>air</a>
<a style='font-size: 133%' href='/tags.html#actionscript'>actionscript</a>
<a style='font-size: 113%' href='/tags.html#crack'>crack</a>
<a style='font-size: 70%' href='/tags.html#ios'>ios</a>
<a style='font-size: 170%' href='/tags.html#fms'>fms</a>
<a style='font-size: 70%' href='/tags.html#vim'>vim</a>
<a style='font-size: 70%' href='/tags.html#error'>error</a>

	</div>
	
  <div class="prev-next">
  
    <a href="/2014/08/06/bitmapdata" class="next" title="bitmapdata">Next Post &rarr;</a>
  
  
    <a href="/actionscript/2014/07/30/mmcfg" class="prev" title="mm.cfg">&larr; Earlier Post</a>
  
  </div>
  
</div><!-- End Page -->

	




  <!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1926112"></script>
<!-- UY END -->





  
  <div id="footer">
  	<address>
  		<span class="copyright">
  			Content by <a href="/info/site.html">lsj</a>. Design by 
  			<a href="http://mark.reid.name/">Mark Reid</a>
  			<br/>
  			(<a rel="licence" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Some rights reserved</a>)			
  		</span>
  		<span class="engine">
  			Powered by <a href="http://github.com/mojombo/jekyll/" title="A static, minimalist CMS">Jekyll</a>
  		</span>
  	</address>
  </div>
  
</div>



<!--[if IE 6]>
<script type="text/javascript"> 
	/*Load jQuery if not already loaded*/ if(typeof jQuery == 'undefined'){ document.write("<script type=\"text/javascript\"   src=\"http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js\"></"+"script>"); var __noconflict = true; } 
	var IE6UPDATE_OPTIONS = {
		icons_path: "http://static.ie6update.com/hosted/ie6update/images/"
	}
</script>
<script type="text/javascript" src="http://static.ie6update.com/hosted/ie6update/ie6update.js"></script>
<![endif]-->

  
  


<script type="text/javascript"> 
<!-- 
(function(){ 
var S=navigator.userAgent.indexOf("MSIE")!=-1&&!window.opera; 
function M(C){ 
return document.getElementById(C) 
} function R(C){ 
return document.createElement(C) 
} var P=[19416,19168,42352,21717,53856,55632,91476,22176,39632,21970,19168,42422,42192,53840,119381,46400,54944,44450,38320,84343,18800,42160,46261,27216,27968,109396,11104,38256,21234,18800,25958,54432,59984,28309,23248,11104,100067,37600,116951,51536,54432,120998,46416,22176,107956,9680,37584,53938,43344,46423,27808,46416,86869,19872,42448,83315,21200,43432,59728,27296,44710,43856,19296,43748,42352,21088,62051,55632,23383,22176,38608,19925,19152,42192,54484,53840,54616,46400,46496,103846,38320,18864,43380,42160,45690,27216,27968,44870,43872,38256,19189,18800,25776,29859,59984,27480,21952,43872,38613,37600,51552,55636,54432,55888,30034,22176,43959,9680,37584,51893,43344,46240,47780,44368,21977,19360,42416,86390,21168,43312,31060,27296,44368,23378,19296,42726,42208,53856,60005,54576,23200,30371,38608,19415,19152,42192,118966,53840,54560,56645,46496,22224,21938,18864,42359,42160,43600,111189,27936,44448]; 
var K="甲乙丙丁戊己庚辛壬癸"; 
var J="子丑寅卯辰巳午未申酉戌亥"; 
var O="鼠牛虎兔龙蛇马羊猴鸡狗猪"; 
var L=["小寒","大寒","立春","雨水","惊蛰","春分","清明","谷雨","立夏","小满","芒种","夏至","小暑","大暑","立秋","处暑","白露","秋分","寒露","霜降","立冬","小雪","大雪","冬至"]; 
var D=[0,21208,43467,63836,85337,107014,128867,150921,173149,195551,218072,240693,263343,285989,308563,331033,353350,375494,397447,419210,440795,462224,483532,504758]; 
var B="日一二三四五六七八九十"; 
var H=["正","二","三","四","五","六","七","八","九","十","十一","腊"]; 
var E="初十廿卅"; 
var V={ 
"0101":"*1元旦节","0214":"情人节","0305":"学雷锋纪念日","0308":"妇女节","0312":"植树节","0315":"消费者权益日","0401":"愚人节","0501":"*1劳动节","0504":"青年节","0601":"国际儿童节","0701":"中国共产党诞辰","0801":"建军节","0910":"中国教师节","1001":"*3国庆节","1224":"平安夜","1225":"圣诞节" 
} ; 
var T={ 
"0101":"*2春节","0115":"元宵节","0505":"*1端午节","0815":"*1中秋节","0909":"重阳节","1208":"腊八节","0100":"除夕" 
} ; 
function U(Y){ 
function c(j,i){ 
var h=new Date((31556925974.7*(j-1900)+D[i]*60000)+Date.UTC(1900,0,6,2,5)); 
return(h.getUTCDate()) 
} function d(k){ 
var h,j=348; 
for(h=32768;h>8;h>>=1){ 
j+=(P[k-1900]&h)?1:0 
} return(j+b(k)) 
} function a(h){ 
return(K.charAt(h%10)+J.charAt(h%12)) 
} function b(h){ 
if(g(h)){ 
return((P[h-1900]&65536)?30:29) 
} else{ 
return(0) 
} 
} function g(h){ 
return(P[h-1900]&15) 
} function e(i,h){ 
return((P[i-1900]&(65536>>h))?30:29) 
} function C(m){ 
var k,j=0,h=0; 
var l=new Date(1900,0,31); 
var n=(m-l)/86400000; 
this.dayCyl=n+40; 
this.monCyl=14; 
for(k=1900;k<2050&&n>0;k++){ 
h=d(k); 
n-=h; 
this.monCyl+=12 
} if(n<0){ 
n+=h; 
k--; 
this.monCyl-=12 
} this.year=k; 
this.yearCyl=k-1864; 
j=g(k); 
this.isLeap=false; 
for(k=1;k<13&&n>0;k++){ 
if(j>0&&k==(j+1)&&this.isLeap==false){ 
--k; 
this.isLeap=true; 
h=b(this.year) 
} else{ 
h=e(this.year,k) 
} if(this.isLeap==true&&k==(j+1)){ 
this.isLeap=false 
} n-=h; 
if(this.isLeap==false){ 
this.monCyl++ 
} 
} if(n==0&&j>0&&k==j+1){ 
if(this.isLeap){ 
this.isLeap=false 
} else{ 
this.isLeap=true; 
--k; 
--this.monCyl 
} 
} if(n<0){ 
n+=h; 
--k; 
--this.monCyl 
} this.month=k; 
this.day=n+1 
} function G(h){ 
return h<10?"0"+h:h 
} function f(i,j){ 
var h=i; 
return j.replace(/dd?d?d?|MM?M?M?|yy?y?y?/g,function(k){ 
switch(k){ 
case"yyyy":var l="000"+h.getFullYear(); 
return l.substring(l.length-4); 
case"dd":return G(h.getDate()); 
case"d":return h.getDate().toString(); 
case"MM":return G((h.getMonth()+1)); 
case"M":return h.getMonth()+1 
} 
} ) 
} function Z(i,h){ 
var j; 
switch(i,h){ 
case 10:j="初十"; 
break; 
case 20:j="二十"; 
break; 
case 30:j="三十"; 
break; 
default:j=E.charAt(Math.floor(h/10)); 
j+=B.charAt(h%10) 
} return(j) 
} this.date=Y; 
this.isToday=false; 
this.isRestDay=false; 
this.solarYear=f(Y,"yyyy"); 
this.solarMonth=f(Y,"M"); 
this.solarDate=f(Y,"d"); 
this.solarWeekDay=Y.getDay(); 
this.solarWeekDayInChinese="星期"+B.charAt(this.solarWeekDay); 
var X=new C(Y); 
this.lunarYear=X.year; 
this.shengxiao=O.charAt((this.lunarYear-4)%12); 
this.lunarMonth=X.month; 
this.lunarIsLeapMonth=X.isLeap; 
this.lunarMonthInChinese=this.lunarIsLeapMonth?"闰"+H[X.month-1]:H[X.month-1]; 
this.lunarDate=X.day; 
this.showInLunar=this.lunarDateInChinese=Z(this.lunarMonth,this.lunarDate); 
if(this.lunarDate==1){ 
this.showInLunar=this.lunarMonthInChinese+"月" 
} this.ganzhiYear=a(X.yearCyl); 
this.ganzhiMonth=a(X.monCyl); 
this.ganzhiDate=a(X.dayCyl++); 
this.jieqi=""; 
this.restDays=0; 
if(c(this.solarYear,(this.solarMonth-1)*2)==f(Y,"d")){ 
this.showInLunar=this.jieqi=L[(this.solarMonth-1)*2] 
} if(c(this.solarYear,(this.solarMonth-1)*2+1)==f(Y,"d")){ 
this.showInLunar=this.jieqi=L[(this.solarMonth-1)*2+1] 
} if(this.showInLunar=="清明"){ 
this.showInLunar="清明节"; 
this.restDays=1 
} this.solarFestival=V[f(Y,"MM")+f(Y,"dd")]; 
if(typeof this.solarFestival=="undefined"){ 
this.solarFestival="" 
} else{ 
if(/\*(\d)/.test(this.solarFestival)){ 
this.restDays=parseInt(RegExp.$1); 
this.solarFestival=this.solarFestival.replace(/\*\d/,"") 
} 
} this.showInLunar=(this.solarFestival=="")?this.showInLunar:this.solarFestival; 
this.lunarFestival=T[this.lunarIsLeapMonth?"00":G(this.lunarMonth)+G(this.lunarDate)]; 
if(typeof this.lunarFestival=="undefined"){ 
this.lunarFestival="" 
} else{ 
if(/\*(\d)/.test(this.lunarFestival)){ 
this.restDays=(this.restDays>parseInt(RegExp.$1))?this.restDays:parseInt(RegExp.$1); 
this.lunarFestival=this.lunarFestival.replace(/\*\d/,"") 
} 
} if(this.lunarMonth==12&&this.lunarDate==e(this.lunarYear,12)){ 
this.lunarFestival=T["0100"]; 
this.restDays=1 
} this.showInLunar=(this.lunarFestival=="")?this.showInLunar:this.lunarFestival; 
this.showInLunar=(this.showInLunar.length>4)?this.showInLunar.substr(0,2)+"...":this.showInLunar 
} var Q=(function(){ 
var X={ 
} ; 
X.lines=0; 
X.dateArray=new Array(42); 
function Y(a){ 
return(((a%4===0)&&(a%100!==0))||(a%400===0)) 
} function G(a,b){ 
return[31,(Y(a)?29:28),31,30,31,30,31,31,30,31,30,31][b] 
} function C(a,b){ 
a.setDate(a.getDate()+b); 
return a 
} function Z(a){ 
var f=0; 
var c=new U(new Date(a.solarYear,a.solarMonth-1,1)); 
var d=(c.solarWeekDay-1==-1)?6:c.solarWeekDay-1; 
X.lines=Math.ceil((d+G(a.solarYear,a.solarMonth-1))/7); 
for(var e=0;e<X.dateArray.length;e++){ 
if(c.restDays!=0){ 
f=c.restDays 
} if(f>0){ 
c.isRest=true 
} if(d-->0||c.solarMonth!=a.solarMonth){ 
X.dateArray[e]=null; 
continue 
} var b=new U(new Date()); 
if(c.solarYear==b.solarYear&&c.solarMonth==b.solarMonth&&c.solarDate==b.solarDate){ 
c.isToday=true 
} X.dateArray[e]=c; 
c=new U(C(c.date,1)); 
f-- 
} 
} return{ 
init:function(a){ 
Z(a) 
} ,getJson:function(){ 
return X 
} 
} 
} )(); 
var W=(function(){ 
var C=M("top").getElementsByTagName("SELECT")[0]; 
var X=M("top").getElementsByTagName("SELECT")[1]; 
var G=M("top").getElementsByTagName("SPAN")[0]; 
var c=M("top").getElementsByTagName("SPAN")[1]; 
var Y=M("top").getElementsByTagName("INPUT")[0]; 
function a(g){ 
G.innerHTML=g.ganzhiYear; 
c.innerHTML=g.shengxiao 
} function b(g){ 
C[g.solarYear-1901].selected=true; 
X[g.solarMonth-1].selected=true 
} function f(){ 
var j=C.value; 
var g=X.value; 
var i=new U(new Date(j,g-1,1)); 
Q.init(i); 
N.draw(); 
if(this==C){ 
i=new U(new Date(j,3,1)); 
G.innerHTML=i.ganzhiYear; 
c.innerHTML=i.shengxiao 
} var h=new U(new Date()); 
Y.style.visibility=(j==h.solarYear&&g==h.solarMonth)?"hidden":"visible" 
} function Z(){ 
var g=new U(new Date()); 
a(g); 
b(g); 
Q.init(g); 
N.draw(); 
Y.style.visibility="hidden" 
} function d(k,g){ 
for(var j=1901;j<2050;j++){ 
var h=R("OPTION"); 
h.value=j; 
h.innerHTML=j; 
if(j==k){ 
h.selected="selected" 
} C.appendChild(h) 
} for(var j=1;j<13;j++){ 
var h=R("OPTION"); 
h.value=j; 
h.innerHTML=j; 
if(j==g){ 
h.selected="selected" 
} X.appendChild(h) 
} C.onchange=f; 
X.onchange=f 
} function e(g){ 
d(g.solarYear,g.solarMonth); 
G.innerHTML=g.ganzhiYear; 
c.innerHTML=g.shengxiao; 
Y.onclick=Z; 
Y.style.visibility="hidden" 
} return{ 
init:function(g){ 
e(g) 
} ,reset:function(g){ 
b(g) 
} 
} 
} )(); 
var N=(function(){ 
function C(){ 
var Z=Q.getJson(); 
var c=Z.dateArray; 
M("cm").style.height=Z.lines*38+2+"px"; 
M("cm").innerHTML=""; 
for(var a=0;a<c.length;a++){ 
if(c[a]==null){ 
continue 
} var X=R("DIV"); 
if(c[a].isToday){ 
X.style.border="1px solid #a5b9da"; 
X.style.background="#c1d9ff" 
} X.className="cell"; 
X.style.left=(a%7)*34+"px"; 
X.style.top=Math.floor(a/7)*38+2+"px"; 
var b=R("DIV"); 
b.className="so"; 
// http://www.codefans.net 
b.style.color=((a%7)>4||c[a].isRest)?"#c60b02":"#313131"; 
b.innerHTML=c[a].solarDate; 
X.appendChild(b); 
var Y=R("DIV"); 
Y.style.color="#666"; 
Y.innerHTML=c[a].showInLunar; 
X.appendChild(Y); 
X.onmouseover=(function(d){ 
return function(f){ 
F.show({ 
dateIndex:d,cell:this 
} ) 
} 
} )(a); 
X.onmouseout=function(){ 
F.hide() 
} ; 
M("cm").appendChild(X) 
} var G=R("DIV"); 
G.id="fd"; 
M("cm").appendChild(G); 
F.init(G) 
} return{ 
draw:function(G){ 
C(G) 
} 
} 
} )(); 
var F=(function(){ 
var C; 
function Y(e,c){ 
if(arguments.length>1){ 
var b=/([.*+?^=!:${}()|[\]\/\\])/g,Z="{".replace(b,"\\$1"),d="}".replace(b,"\\$1"); 
var a=new RegExp("#"+Z+"([^"+Z+d+"]+)"+d,"g"); 
if(typeof (c)=="object"){ 
return e.replace(a,function(f,h){ 
var g=c[h]; 
return typeof (g)=="undefined"?"":g 
} ) 
} 
} return e 
} function G(b){ 
var a=Q.getJson().dateArray[b.dateIndex]; 
var Z=b.cell; 
var c="#{solarYear} 年 #{solarMonth} 月 #{solarDate} 日 #{solarWeekDayInChinese}"; 
c+="<br><b> #{lunarMonthInChinese}月#{lunarDateInChinese}</b>"; 
c+="<br>#{ganzhiYear}年 #{ganzhiMonth}月 #{ganzhiDate}日"; 
if(a.solarFestival!=""||a.lunarFestival!=""||a.jieqi!=""){ 
c+="<br><b>#{lunarFestival} #{solarFestival} #{jieqi}</b>" 
} C.innerHTML=Y(c,a); 
C.style.top=Z.offsetTop+Z.offsetHeight-5+"px"; 
C.style.left=Z.offsetLeft+Z.offsetWidth-5+"px"; 
C.style.display="block" 
} function X(){ 
C.style.display="none" 
} return{ 
show:function(Z){ 
G(Z) 
} ,hide:function(){ 
X() 
} ,init:function(Z){ 
C=Z 
} 
} 
} )(); 
var A=new U(new Date()); 
if(S){ 
window.attachEvent("onload",function(){ 
W.reset(A) 
} ) 
} W.init(A); 
Q.init(A); 
N.draw(); 
} )(); 
//--> 
</script>
  
</body>
</html>

