---
title: 消息机制
toc: true
tags: Dart
---

## 概述

Dart在执行完main函数后，就会由Loop开始执行两个任务队列中的Event。首先Loop检查微服务队列，依次执行Event，当微服务队列执行完后，就检查Event queue队列依次执行，在执行Event queue的过程中，没执行完一个Event就再检查一次微服务队列。所以微服务队列优先级高，可以利用微服务进行插队。




- event队列：包含所有外来的事件：I/O，mouse events，drawing events，timers，isolate之间的message等。

- microtask队列：在Dart中是必要的，因为有时候事件处理想要在稍后完成一些任务但又希望是在执行下一个事件消息之前。



![](./消息机制.png)



## 总结

- Dart事件循环执行两个队列里的事件：event队列和microtask队列。
- event队列的事件来自dart（future，timer，isolate message等）和系统（用户输入，I/O等）。
- 目前为止，microtask队列的事件只来自dart。
- 事件循环会优先清空microtask队列，然后才会去处理event队列。
- 当两个队列都清空后，dart就会退出。
- main方法，来自event队列和microtask队列的所有事件都运行在Dart的main isolate中。

当你要安排一个任务时，请遵守以下规则：

- 如果可以，尽量将任务放入event队列中。
- 使用Future的then方法或whenComplete方法来指定任务顺序。
- 为了保持你app的可响应性，尽量不要将大计算量的任务放入这两个队列。
- 大计算量的任务放入额外的isolate中。




## 参考

- [Dart与消息循环机制翻译](https://www.jianshu.com/p/7549b63a72d7)
