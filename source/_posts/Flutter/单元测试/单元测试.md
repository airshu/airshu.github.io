---
title: 单元测试
toc: true
tags: Flutter 单元测试
---

单元测试的作用？

- 保证代码质量，当一个方法在某个版本进行了调整，如果对应的单元测试无法通过，说明这个方法的改动有问题。单元测试中也能包含很多边界条件，甚至可以把测试用例的场景都包含，这样就相当于做了一遍测试的工作，而且可以复用检查，下次迭代时再运行一遍，说不定能发现新问题
- 单元测试阶段发现bug的处理时间相对后期测试发现反馈给研发，处理的时间要短很多，提高效率

单元测试做的好不好，在于测试用例的有效性

测试的评价指标：

- 通过率
- 覆盖率
- 有测试用例

## 测试方法

- Code Review
- 静态代码扫描
- 单元测试用例编写：综合运用黑盒测试、白盒测试方法来进行测试用例设计

## 测试用例规范



## 单元测试的最佳实践

- 模块化代码：将代码分解为小的、可重复使用的模块，每个模块只负责一个特定的功能。这样可以更容易地针对单个模块编写测试用例。
- 避免依赖：代码中应避免使用全局变量、静态方法或其他硬编码的依赖项，因为这些会增加测试的复杂性。相反，应使用依赖注入或其他技术来模拟依赖项。


## 方法、函数的测试

## 测试网络请求

## 测试UI

## 测试Bloc

## 集成测试



## Flutter如何进行单元测试

- 单元测试ー单元测试对单个函数、方法或类执行测试。我们使用单元测试来测试您想要测试的非常小的代码或函数。
- widget 测试ー widget 测试(在其他 UI 框架中称为组件测试)测试单个 widget 。
- 集成测试ーー集成测试测试一个完整的应用程序或应用程序的很大一部分，这些应用程序将许多事情和测试结合在一起，比如创建一个流。

## Flutter单元测试库

```yaml
dev_dependencies:
  test: # 纯dart测试框架
  flutter_test: # 基于test的flutter测试框架
    sdk: flutter
  flutter_driver:
    sdk: flutter
  mockito:
  http_mock_adapter:  
  bloc_test:
  test_api: # dart测试框架
  integration_test: # 集成测试
  
```

## flutter_test

基于dart的test库，用于Flutter项目的测试库，跟其他语言类似，提供了一些测试的方法，如expect、group、test、testWidgets、setUp、tearDown等。

[https://api.flutter.dev/flutter/flutter_test/flutter_test-library.html](https://api.flutter.dev/flutter/flutter_test/flutter_test-library.html)

### 基本用法

```dart
@Skip('跳过当前测试用例')
@Timeout(Duration(seconds: 10)) //设置超时时间
import 'package:flutter_test/flutter_test.dart';

void main() {

  setUp(() { //在每个测试用例执行前执行

  });

  tearDown(() { //在每个测试用例执行后执行

  });

  test('描述测试内容', () async { //支持异步测试
    expect(1+1, 2);
  });

  group('描述分组', () {

    test('描述测试内容', () async {

    });

  }, skip: '跳过当前分组',
  timeout: Timeout(Duration(seconds: 10)) //设置超时时间
  );


}

```

### 方法介绍

- expect：断言，判断是否符合预期
- group：分组，可以把一些相关的测试用例放在一起
- test：单个测试用例
- testWidgets：测试UI
  - pumpWidget()：创建并渲染widget
  - pump(): 触发widget重建，仅重建已更改的 widget
  - pumpAndSettle():在给定期间内不断重复调用 pump() 直到完成所有绘制帧，一般需要等到所有动画全部完成

- setUp：在每个测试用例执行前执行
- tearDown：在每个测试用例执行后执行

**交互类API**

- enterText(): 模拟输入
- tap(): 模拟点击
- drag(): 模拟拖拽
- longPress():模拟长按
- scrollUntilVisible(): 模拟滚动到可见位置
- scrollIntoView(): 模拟滚动到可见位置
- scroll(): 模拟滚动
- fling(): 模拟拖拽
- flingFrom(): 模拟拖拽
- flingFromEdge(): 模拟拖拽
- flingFromCenter(): 模拟拖拽

**使用Finder定位Widget**

- text(String text): 查找特定文本的Text widget
- byWidget(Widget widget, {bool skipOffstage = true}): 通过widget查找widget
- byKey(Key key): 通过key查找widget
- byType(Type type): 通过类型查找widget
- byWidget(Widget widget):
- byElementType(Type type, { bool skipOffstage = true }):

**matchers**

- findsOneWidget： 找到一个widget
- findsWidgets：找到一个或多个
- findsNothing：没有找到
- findsNWidgets：找到指定数量的widget

- TestPointer：测试手势，按下、滑动、抬起等
- TestTextInput：测试输入框
- AutomatedTestWidgetsFlutterBinding：会模拟用户操作并控制应用程序的状态。它可以处理异步操作、动画和定时器等，以确保测试代码在正确的上下文中运行。通常与 flutter_driver 或其他自动化测试框架一起使用，用于执行集成测试或端到端测试
- AnimationSheetBuilder：用于测试动画

## mockito

- [https://pub.dev/packages/mockito](https://pub.dev/packages/mockito)
- [文档中文翻译](https://juejin.cn/post/7060884659508346893)

mockito库用来模拟数据。 使用Mockito产生的mock类，需要添加build_runner依赖。有以下主要用途：

- 可通过标注或Fake的方式来生成mock类
- 可通过when().thenReturn()来模拟方法的返回值
- 可通过argThat()来模拟方法的参数
- 可通过verify()来验证方法的调用
  - verifyInOrder可校验顺序
  - 可通过verifyNoMoreInteractions()来验证没有更多的调用
  - 可通过reset()来重置mock
  - 可通过verifyZeroInteractions()来验证没有调用
  - 可通过verifyNever()来验证没有调用
  - 可通过verifyInOrder()来验证顺序
  - 可通过verifyStream()来验证Stream
  - 可通过verifyStreamEvent()来验证Stream的事件
  - called能校验调用次数
  - captured存储调用时的参数





### thenReturn、thenAnswer


- thenReturn会返回Future或Stream，可能抛出ArgumentError
- thenAnswer只会返回Future或Stream




## http_mock_adapter

## bloc_test

- [https://pub.dev/packages/bloc_test](https://pub.dev/packages/bloc_test)

```dart

void blocTest<B extends BlocBase<State>, State>(
  String description, { //测试的描述
  required B Function() build, //创建bloc
  FutureOr<void> Function()? setUp, //在每个测试用例执行前执行
  State Function()? seed,
  dynamic Function(B bloc)? act, //执行的动作
  Duration? wait,
  int skip = 0,
  dynamic Function()? expect, //期望的结果
  dynamic Function(B bloc)? verify,
  dynamic Function()? errors,
  FutureOr<void> Function()? tearDown, //在每个测试用例执行后执行
  dynamic tags,
})

```

## flutter_driver

集成测试框架

## 参考

- [5个关键问题让单元测试的价值最大化](https://mp.weixin.qq.com/s/8JC_vaFOgiJPIH7yfbP25A)
- [单元测试介绍](https://flutter.cn/docs/cookbook/testing/unit/introduction)
- [如何写出有效的单元测试](https://mp.weixin.qq.com/s/Y75fSX92kysSmYrhEH6QFQ)
- [Flutter如何Mock MethodChannel进行单元测试](https://www.duidaima.com/Group/Topic/Flutter/10262)
- []()
- []()
