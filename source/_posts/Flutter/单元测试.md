---
title: 单元测试
toc: true
tags: Flutter 单元测试
---

单元测试的作用？

- 保证代码质量，当一个方法在某个版本进行了调整，如果对应的单元测试无法通过，说明这个方法的改动有问题。单元测试中也能包含很多边界条件，甚至可以把测试用例的场景都包含，这样就相当于做了一遍测试的工作，而且可以复用检查，下次迭代时再运行一遍，说不定能发现新问题
- 单元测试阶段发现bug的处理时间相对后期测试发现反馈给研发，处理的时间要短很多，提高效率


单元测试做的好不好，在于测试用例的有效性

测试的评价指标：

- 通过率
- 覆盖率
- 有测试用例






## 测试方法

- Code Review
- 静态代码扫描
- 单元测试用例编写：综合运用黑盒测试、白盒测试方法来进行测试用例设计



## 测试用例规范




## 测试网络请求

## 测试UI

## 测试Bloc



## Flutter单元测试库

```yaml
dev_dependencies:
  test: # 纯dart测试框架
  flutter_test: # 基于test的flutter测试框架
    sdk: flutter
  flutter_driver:
    sdk: flutter
  mockito:
  http_mock_adapter:  
  bloc_test:
  test_api:
  
```


### flutter_test

Flutter自带的测试库，跟其他语言类似，提供了一些测试的方法，如expect、group、test、testWidgets、setUp、tearDown等。


#### 基本用法

```dart
@Skip('跳过当前测试用例')
@Timeout(Duration(seconds: 10)) //设置超时时间
import 'package:flutter_test/flutter_test.dart';

void main() {

  setUp(() { //在每个测试用例执行前执行

  });

  tearDown(() { //在每个测试用例执行后执行

  });

  test('描述测试内容', () async { //支持异步测试
    expect(1+1, 2);
  });

  group('描述分组', () {

    test('描述测试内容', () async {

    });

  }, skip: '跳过当前分组',
  timeout: Timeout(Duration(seconds: 10)) //设置超时时间
  );


}

```

#### 方法介绍

- expect：断言，判断是否符合预期
- group：分组，可以把一些相关的测试用例放在一起
- test：单个测试用例
- testWidgets：测试UI
  - pumpWidget()：创建并渲染widget
  - pump(): 触发widget重建，仅重建已更改的 widget
  pumpAndSettle():在给定期间内不断重复调用 pump() 直到完成所有绘制帧，一般需要等到所有动画全部完成

- setUp：在每个测试用例执行前执行
- tearDown：在每个测试用例执行后执行


**交互类API**
- enterText():
- tap():
- drag():
- longPress():


**使用Finder定位Widget**

- text(String text): 查找特定文本的Text widget
- byWidget(Widget widget, {bool skipOffstage = true}): 通过widget查找widget
- byKey(Key key): 通过key查找widget
- byType(Type type): 通过类型查找widget
- byWidget(Widget widget):
- byElementType(Type type, { bool skipOffstage = true }):

**matchers**

- findsOneWidget： 找到一个widget
- findsWidgets：找到一个或多个
- findsNothing：没有找到
- findsNWidgets：找到指定数量的widget


- TestPointer：测试手势，按下、滑动、抬起等
- TestTextInput：测试输入框
- AutomatedTestWidgetsFlutterBinding：会模拟用户操作并控制应用程序的状态。它可以处理异步操作、动画和定时器等，以确保测试代码在正确的上下文中运行。通常与 flutter_driver 或其他自动化测试框架一起使用，用于执行集成测试或端到端测试
- AnimationSheetBuilder：用于测试动画



### mockito

- [https://pub.dev/packages/mockito](https://pub.dev/packages/mockito)

mockito库用来模拟数据。 使用Mockito产生的mock类，需要添加build_runner依赖


### http_mock_adapter

### bloc_test

- [https://pub.dev/packages/bloc_test](https://pub.dev/packages/bloc_test)

```dart

void blocTest<B extends BlocBase<State>, State>(
  String description, { //测试的描述
  required B Function() build, //创建bloc
  FutureOr<void> Function()? setUp, //在每个测试用例执行前执行
  State Function()? seed,
  dynamic Function(B bloc)? act, //执行的动作
  Duration? wait,
  int skip = 0,
  dynamic Function()? expect, //期望的结果
  dynamic Function(B bloc)? verify,
  dynamic Function()? errors,
  FutureOr<void> Function()? tearDown, //在每个测试用例执行后执行
  dynamic tags,
})

```



## 参考

- [5个关键问题让单元测试的价值最大化](https://mp.weixin.qq.com/s/8JC_vaFOgiJPIH7yfbP25A)
- [单元测试介绍](https://flutter.cn/docs/cookbook/testing/unit/introduction)
- [如何写出有效的单元测试](https://mp.weixin.qq.com/s/Y75fSX92kysSmYrhEH6QFQ)